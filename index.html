<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ íŠœë¸Œ ì¡°íšŒìˆ˜ íŠ¸ë˜ì»¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0d7377 0%, #14FFEC 50%, #00CEC9 100%);
        }
    </style>
</head>
<body class="p-3 sm:p-6 min-h-screen">
    
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-5 sm:p-6 mb-4">
            <div class="flex items-center justify-between mb-5 gap-3">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-black text-teal-700"> ì¥ë¯¼í˜¸ ANALOG Vol.1 </h1>
                    <p id="lastUpdate" class="text-sm text-gray-500 mt-1"></p>
                </div>
                <div class="flex gap-2 text-sm sm:text-base">
                    <button onclick="toggleV15Sync()" id="syncBtn" class="bg-blue-600 text-white px-4 py-2.5 rounded-lg hover:bg-blue-700 font-bold shadow-md transition">
                        ğŸ”— V15ì—°ë™
                    </button>
                    <button onclick="copyLink()" class="bg-teal-600 text-white px-4 py-2.5 rounded-lg hover:bg-teal-700 font-bold shadow-md transition">
                        ğŸ“‹ <span id="copyText">ë³µì‚¬</span>
                    </button>
                    <button onclick="toggleAdmin()" id="adminBtn" class="bg-cyan-600 text-white px-4 py-2.5 rounded-lg hover:bg-cyan-700 font-bold shadow-md transition">
                        ğŸ” ê´€ë¦¬
                    </button>
                    <button onclick="saveData()" id="saveBtn" class="hidden bg-emerald-600 text-white px-4 py-2.5 rounded-lg hover:bg-emerald-700 font-bold shadow-md transition">
                        ğŸ’¾ ì €ì¥
                    </button>
                </div>
            </div>

            <div class="bg-gradient-to-r from-teal-100 to-cyan-100 rounded-xl p-4 mb-5 text-center shadow-inner">
                <div class="text-lg font-bold text-gray-700 mb-2"> ANALOG Vol.1 íŠ¸ë˜ì»¤ </div>
                <div class="text-sm text-gray-600 mb-3">
                    <span id="syncStatus" class="font-bold text-gray-500">V15 ì—°ë™ ëŒ€ê¸°ì¤‘ (ë²„íŠ¼ í´ë¦­)</span>
                </div>
                <div class="flex justify-center gap-6">
                    <div>
                        <div class="text-xs text-gray-500">ì „ì²´ í‰ê·  ë‹¬ì„±ë¥ </div>
                        <div id="avgRate" class="text-3xl font-black text-teal-700">0.0%</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500">V13 ëˆ„ì </div>
                        <div id="v13Total" class="text-2xl font-black text-cyan-700">0</div>
                    </div>
                </div>
            </div>

            <!-- ì „ì²´ ê³¡ -->
            <div class="mb-6">
                <h2 class="text-xl font-black text-gray-700 mb-3 flex items-center gap-2">
                    <span class="bg-teal-600 text-white px-3 py-1 rounded-lg text-sm">ì „ì²´ 13ê³¡</span>
                    ì‹œê°„ëŒ€ë³„ ê¸°ë¡
                </h2>
                <div id="allsongs" class="space-y-4"></div>
            </div>

            <!-- V13 ì§‘ê³„ -->
            <div>
                <h2 class="text-xl font-black text-gray-700 mb-3 flex items-center gap-2">
                    <span class="bg-cyan-600 text-white px-3 py-1 rounded-lg text-sm">V13 (8ê³¡)</span>
                    ì§‘ê³„ ê²°ê³¼ (ìë™ ë°˜ì˜)
                </h2>
                <div id="v13summary" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <div class="text-center text-white text-sm mb-4">
            ğŸ’™ Made with  by ë¯¼í˜¸íŠ¹ê³µëŒ€ğŸ’™
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-8 max-w-sm w-full shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 text-teal-700 text-center">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
            <input type="password" id="pwd" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full px-4 py-3 border-2 border-teal-300 rounded-lg mb-4 text-lg">
            <div id="error" class="hidden text-red-600 text-base mb-4 font-semibold text-center"></div>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg text-base font-bold hover:bg-gray-100 transition">ì·¨ì†Œ</button>
                <button onclick="login()" class="flex-1 bg-teal-600 text-white px-4 py-3 rounded-lg text-base font-bold hover:bg-teal-700 transition">ë¡œê·¸ì¸</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        const ALL_SONGS = [
            { name: "Hankyeryeong Pass", isV13: true },
            { name: "Lonely Love", isV13: true },
            { name: "My Reflection in My Heart", isV13: true },
            { name: "ë‚´ ê³ì— ìˆì–´ì£¼ | ì•¼ì™¸ë…¹ìŒì‹¤ LIVE", isV13: true },
            { name: "I'll Give You the Love I Have Left", isV13: true },
            { name: "Just a Friend", isV13: true },
            { name: "That Day", isV13: true },
            { name: "I will let go", isV13: true },
            { name: "ë‚´ ê³ì— ìˆì–´ì£¼ Official MV", isV13: false },
            { name: "Stay by My Side | 1theK", isV13: false },
            { name: "í•œê³„ë ¹ Official MV", isV13: false },
            { name: "Hankyeryeong Pass | 1theK", isV13: false },
            { name: "í™€ë¡œëœ ì‚¬ë‘ | íŠ¸ë¡¯ì±”í”¼ì–¸", isV13: false }
        ];

        let isAdmin = false;
        let isV15Syncing = false;
        let db;
        let data = {
            times: ["ì‹œê°„1", "ì‹œê°„2", "ì‹œê°„3", "ì‹œê°„4", "ì‹œê°„5"],
            goals: Array(13).fill(100000),
            views: Array(13).fill(null).map(() => [0,0,0,0,0])
        };

        firebase.initializeApp({
            apiKey: "AIzaSyDk0r98Ag5htVKH-vVxUzG52SYNcX1G0sA",
            authDomain: "analog-vol1-mv.firebaseapp.com",
            databaseURL: "https://analog-vol1-mv-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "analog-vol1-mv",
            storageBucket: "analog-vol1-mv.firebasestorage.app",
            messagingSenderId: "40601613117",
            appId: "1:40601613117:web:de43110328bc627df14b54"
        });
        db = firebase.database();

        // V15 ì—°ë™: í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ views ê²½ë¡œ ì‹¤ì‹œê°„ ê°ì§€
        let v15Listener = null;
        
        function toggleV15Sync() {
            isV15Syncing = !isV15Syncing;
            const btn = document.getElementById("syncBtn");
            const status = document.getElementById("syncStatus");
            
            if (isV15Syncing) {
                btn.textContent = "ğŸ”— V15ì—°ë™ì¤‘";
                btn.classList.remove("bg-blue-600", "hover:bg-blue-700");
                btn.classList.add("bg-green-600", "hover:bg-green-700");
                status.textContent = "âœ… V15 ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±í™”";
                status.className = "font-bold text-green-600";
                
                // V15 ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                v15Listener = db.ref("views").on("value", snap => {
                    const v15Views = snap.val();
                    if (v15Views) {
                        ALL_SONGS.forEach((song, i) => {
                            if (v15Views[i] !== undefined && v15Views[i] > 0) {
                                data.views[i][4] = v15Views[i];
                            }
                        });
                        render();
                    }
                });
            } else {
                btn.textContent = "ğŸ”— V15ì—°ë™";
                btn.classList.remove("bg-green-600", "hover:bg-green-700");
                btn.classList.add("bg-blue-600", "hover:bg-blue-700");
                status.textContent = "V15 ì—°ë™ ëŒ€ê¸°ì¤‘ (ë²„íŠ¼ í´ë¦­)";
                status.className = "font-bold text-gray-500";
                
                // V15 ë¦¬ìŠ¤ë„ˆ ì¤‘ì§€
                if (v15Listener) {
                    db.ref("views").off("value", v15Listener);
                }
            }
        }

        // tracker3 ë°ì´í„° ë¡œë“œ
        db.ref("tracker3").on("value", snap => {
            const val = snap.val();
            if (val) {
                if (val.times) data.times = val.times;
                if (val.goals) data.goals = val.goals;
                if (val.views) {
                    // tracker3ì˜ ì‹œê°„1~4ë§Œ ê°€ì ¸ì˜¤ê³ , ì‹œê°„5ëŠ” V15 ê°’ ìœ ì§€
                    val.views.forEach((viewArray, i) => {
                        if (viewArray) {
                            for (let j = 0; j < 4; j++) {
                                data.views[i][j] = viewArray[j];
                            }
                        }
                    });
                }
                if (val.lastUpdate) {
                    document.getElementById("lastUpdate").textContent = "ì—…ë°ì´íŠ¸: " + val.lastUpdate;
                }
                render();
            }
        });

        function fmt(n) {
            return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function getLatest(views) {
            for (let i = views.length - 1; i >= 0; i--) {
                if (views[i] > 0) return views[i];
            }
            return 0;
        }

        function getRate(views, goal) {
            const latest = getLatest(views);
            return goal > 0 ? Math.min((latest / goal) * 100, 100) : 0;
        }

        function renderAllSongs() {
            let html = "";
            let totalRate = 0;

            ALL_SONGS.forEach((song, i) => {
                const rate = getRate(data.views[i], data.goals[i]);
                const latest = getLatest(data.views[i]);
                totalRate += rate;

                html += `
                    <div class="border-2 border-teal-200 rounded-xl p-4 bg-gradient-to-br from-white to-teal-50 shadow-lg">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex-1 flex items-center gap-2">
                                <h3 class="font-black text-xl text-gray-800">${song.name}</h3>
                                ${song.isV13 ? '<span class="bg-cyan-600 text-white text-xs px-2 py-0.5 rounded font-bold">V13</span>' : ''}
                            </div>
                            <div class="flex gap-4 text-base ml-3">
                                <div class="text-center">
                                    <div class="text-xs text-gray-500">ëª©í‘œ</div>
                                    ${isAdmin ? 
                                        `<input type="number" value="${data.goals[i]}" onchange="updateGoal(${i}, this.value)" 
                                        class="w-24 px-2 py-1 border-2 border-teal-400 rounded-lg bg-teal-50 font-black text-base text-center">` 
                                        : `<div class="font-black text-lg text-teal-700">${fmt(data.goals[i])}</div>`}
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-gray-500">í˜„ì¬</div>
                                    <div class="font-black text-lg text-cyan-600">${fmt(latest)}</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-gray-500">ë‹¬ì„±</div>
                                    <div class="font-black text-lg text-emerald-600">${rate.toFixed(1)}%</div>
                                </div>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-3 shadow-inner">
                            <div class="bg-gradient-to-r from-teal-500 via-cyan-500 to-blue-500 h-3 rounded-full shadow-md transition-all duration-500" style="width:${rate}%"></div>
                        </div>
                        ${isAdmin ? `
                            <div class="bg-white rounded-lg p-3 overflow-x-auto shadow-inner border border-teal-100">
                                <table class="w-full text-sm">
                                    <tr class="border-b-2 border-teal-200">
                                        <th class="p-2 text-left font-bold">ì‹œê°„</th>
                                        ${data.times.map((t,j) => `<th class="p-2"><input type="text" value="${t}" 
                                            onchange="updateTime(${j}, this.value)" 
                                            class="w-full px-2 py-1 border-2 border-teal-300 rounded text-center font-bold"></th>`).join("")}
                                    </tr>
                                    <tr class="border-b border-teal-100">
                                        <td class="p-2 font-bold text-gray-700">ì¡°íšŒìˆ˜</td>
                                        ${data.views[i].map((v,j) => {
                                            const isV15Linked = j === 4 && isV15Syncing;
                                            return `<td class="p-2 ${isV15Linked ? 'bg-cyan-50' : ''}">
                                                ${isV15Linked ? 
                                                    `<div class="text-center font-black text-cyan-700">${fmt(v)}<br><span class="text-xs">V15ì—°ë™</span></div>` :
                                                    `<input type="number" value="${v}" 
                                                        onchange="updateView(${i}, ${j}, this.value)" 
                                                        class="w-full px-2 py-1 border-2 border-gray-300 rounded text-center font-semibold">`
                                                }
                                            </td>`;
                                        }).join("")}
                                    </tr>
                                    <tr>
                                        <td class="p-2 font-bold text-gray-700">ì¦ê°€</td>
                                        ${data.views[i].map((v,j) => {
                                            const inc = j > 0 ? v - data.views[i][j-1] : 0;
                                            return `<td class="p-2 text-center">
                                                <div class="font-black text-base ${inc > 0 ? "text-emerald-600" : "text-gray-300"}">
                                                    ${j > 0 ? "+" + fmt(inc) : "-"}
                                                </div>
                                            </td>`;
                                        }).join("")}
                                    </tr>
                                </table>
                            </div>
                        ` : `
                            <div class="grid grid-cols-5 gap-2 bg-white rounded-lg p-3 shadow-inner border border-teal-100">
                                ${data.times.map((t,j) => {
                                    const inc = j > 0 ? data.views[i][j] - data.views[i][j-1] : 0;
                                    const r = data.goals[i] > 0 ? Math.min((data.views[i][j] / data.goals[i]) * 100, 100) : 0;
                                    const isV15Linked = j === 4 && isV15Syncing;
                                    return `<div class="text-center p-2 rounded-lg ${j > 0 && inc > 0 ? "bg-emerald-50" : ""} ${isV15Linked ? "border-2 border-cyan-400" : ""}">
                                        <div class="text-sm font-bold text-gray-600 mb-1">${t}${isV15Linked ? ' ğŸ”—' : ''}</div>
                                        <div class="text-xl font-black text-gray-800 mb-1">${fmt(data.views[i][j])}</div>
                                        ${j > 0 ? `<div class="text-lg font-black text-emerald-600 mb-1">+${fmt(inc)}</div>` : `<div class="h-7"></div>`}
                                        <div class="text-base font-black text-teal-600">${r.toFixed(1)}%</div>
                                    </div>`;
                                }).join("")}
                            </div>
                        `}
                    </div>
                `;
            });

            document.getElementById("allsongs").innerHTML = html;
            return totalRate;
        }

        function renderV13Summary() {
            let html = "";
            let v13TotalViews = 0;
            let v13TotalGoals = 0;
            let v13Count = 0;

            ALL_SONGS.forEach((song, i) => {
                if (!song.isV13) return;
                
                const latest = getLatest(data.views[i]);
                const goal = data.goals[i];
                const rate = getRate(data.views[i], goal);
                
                v13TotalViews += latest;
                v13TotalGoals += goal;
                v13Count++;

                const firstView = data.views[i][0];
                const increase = latest - firstView;

                html += `
                    <div class="border-2 border-cyan-200 rounded-xl p-4 bg-gradient-to-br from-white to-cyan-50 shadow-lg">
                        <h4 class="font-black text-base text-gray-800 mb-3">${song.name}</h4>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div>
                                <div class="text-xs text-gray-500 mb-1">ì‹œì‘</div>
                                <div class="text-lg font-black text-gray-600">${fmt(firstView)}</div>
                            </div>
                            <div class="bg-emerald-50 rounded-lg p-2">
                                <div class="text-xs text-gray-500 mb-1">ì¦ê°€</div>
                                <div class="text-lg font-black text-emerald-600">+${fmt(increase)}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">í˜„ì¬</div>
                                <div class="text-lg font-black text-cyan-600">${fmt(latest)}</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                <span>ëª©í‘œ: ${fmt(goal)}</span>
                                <span class="font-bold text-cyan-600">${rate.toFixed(1)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-gradient-to-r from-teal-500 to-cyan-500 h-2 rounded-full transition-all duration-500" style="width:${rate}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });

            const v13AvgRate = v13TotalGoals > 0 ? (v13TotalViews / v13TotalGoals) * 100 : 0;
            html = `
                <div class="col-span-1 md:col-span-2 border-2 border-cyan-300 rounded-xl p-4 bg-gradient-to-r from-teal-100 to-cyan-100 shadow-lg mb-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-black text-xl text-teal-800">V13 ì „ì²´ í†µê³„</h4>
                            <div class="text-sm text-gray-600 mt-1">${v13Count}ê³¡ ì§‘ê³„</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-600">ëˆ„ì  ì¡°íšŒìˆ˜</div>
                            <div class="text-2xl font-black text-teal-700">${fmt(v13TotalViews)}</div>
                            <div class="text-lg font-bold text-cyan-600 mt-1">${v13AvgRate.toFixed(1)}% ë‹¬ì„±</div>
                        </div>
                    </div>
                </div>
            ` + html;

            document.getElementById("v13summary").innerHTML = html;
            document.getElementById("v13Total").textContent = fmt(v13TotalViews);
        }

        function render() {
            const totalRate = renderAllSongs();
            renderV13Summary();
            document.getElementById("avgRate").textContent = (totalRate / ALL_SONGS.length).toFixed(1) + "%";
        }

        function updateTime(idx, val) {
            data.times[idx] = val;
            render();
        }

        function updateGoal(idx, val) {
            data.goals[idx] = +val;
            render();
        }

        function updateView(songIdx, timeIdx, val) {
            data.views[songIdx][timeIdx] = +val;
            render();
        }

        function toggleAdmin() {
            if (isAdmin) {
                isAdmin = false;
                document.getElementById("adminBtn").textContent = "ğŸ” ê´€ë¦¬";
                document.getElementById("saveBtn").classList.add("hidden");
                render();
            } else {
                document.getElementById("modal").classList.remove("hidden");
                document.getElementById("pwd").value = "";
                document.getElementById("error").classList.add("hidden");
            }
        }

        function login() {
            if (document.getElementById("pwd").value === "@minho07284") {
                isAdmin = true;
                document.getElementById("adminBtn").textContent = "ğŸšª ë¡œê·¸ì•„ì›ƒ";
                document.getElementById("saveBtn").classList.remove("hidden");
                closeModal();
                render();
            } else {
                document.getElementById("error").textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤";
                document.getElementById("error").classList.remove("hidden");
            }
        }

        function closeModal() {
            document.getElementById("modal").classList.add("hidden");
        }

        function saveData() {
            const saveData = {
                times: data.times,
                goals: data.goals,
                views: data.views.map(viewArray => viewArray.slice(0, 4)), // ì‹œê°„1~4ë§Œ ì €ì¥
                lastUpdate: new Date().toLocaleString("ko-KR")
            };
            db.ref("tracker3").set(saveData).then(() => {
                if (isV15Syncing) {
                    // V15 ì—°ë™ í™œì„±í™” ì‹œì—ë§Œ viewsì— ì €ì¥
                    data.views.forEach((viewArray, i) => {
                        db.ref("views/" + i).set(viewArray[4]);
                    });
                    alert("âœ… ì €ì¥ ì™„ë£Œ! V15ì—ë„ ë°˜ì˜ë©ë‹ˆë‹¤.");
                } else {
                    alert("âœ… ì €ì¥ ì™„ë£Œ!");
                }
            });
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href.split("?")[0]);
            document.getElementById("copyText").textContent = "ì™„ë£Œ!";
            setTimeout(() => document.getElementById("copyText").textContent = "ë³µì‚¬", 2000);
        }

        document.getElementById("pwd").addEventListener("keypress", e => {
            if (e.key === "Enter") login();
        });

        render();
    </script>
</body>
</html>
