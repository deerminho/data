import React, { useState, useEffect } from 'react';
import { Share2, Edit, Eye, TrendingUp, Lock, LogOut, Copy, Check } from 'lucide-react';

const songs = [
  { id: 'Ghg7vG3NMs4', title: 'Hankyeryeong Pass' },
  { id: 'ILppFoa3FTI', title: 'Lonely Love' },
  { id: 'DKgiBUaZXr4', title: 'My Reflection in My Heart' },
  { id: 'BRiBNS0aTVo', title: '내 곁에 있어주 | 야외녹음실 ｜LIVE' },
  { id: '1LlNcwtxsgg', title: 'I\'ll Give You the Love I Have Left' },
  { id: 'rsW-F7IRGmU', title: 'Just a Friend' },
  { id: 'H8ZnFKkc7ps', title: 'That Day' },
  { id: 'q78AVE07wdI', title: 'I will let go' },
  { id: '0JeQF_nrSmU', title: '내 곁에 있어주 (Stay by My Side) Official MV' },
  { id: '33xZoSnV5t0', title: 'Stay by My Side(내 곁에 있어주) | 1theK' },
  { id: 'ZJo6KHpI-2k', title: '한계령 (Hankyeryeong Pass) Official MV' },
  { id: 'C7Y9D4hV3QU', title: 'Hankyeryeong Pass(한계령) | 1theK' }
];

const firebaseConfig = {
  apiKey: "AIzaSyDk0r98Ag5htVKH-vVxUzG52SYNcX1G0sA",
  authDomain: "analog-vol1-mv.firebaseapp.com",
  databaseURL: "https://analog-vol1-mv-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "analog-vol1-mv",
  storageBucket: "analog-vol1-mv.firebasestorage.app",
  messagingSenderId: "40601613117",
  appId: "1:40601613117:web:de43110328bc627df14b54",
  measurementId: "G-SRN2TZCE82"
};

export default function ViewTracker() {
  const [isAdmin, setIsAdmin] = useState(false);
  const [showLogin, setShowLogin] = useState(false);
  const [password, setPassword] = useState('');
  const [loginError, setLoginError] = useState('');
  const [timeLabels, setTimeLabels] = useState(['시간1', '시간2', '시간3', '시간4', '시간5']);
  const [goals, setGoals] = useState(songs.map(() => 100000));
  const [viewData, setViewData] = useState(songs.map(() => Array(5).fill(0)));
  const [db, setDb] = useState(null);
  const [copied, setCopied] = useState(false);
  const [lastUpdate, setLastUpdate] = useState('');

  useEffect(() => {
    const script1 = document.createElement('script');
    script1.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js';
    script1.async = true;
    document.body.appendChild(script1);

    const script2 = document.createElement('script');
    script2.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js';
    script2.async = true;
    document.body.appendChild(script2);

    script2.onload = () => {
      if (window.firebase) {
        const app = window.firebase.initializeApp(firebaseConfig);
        const database = window.firebase.database(app);
        setDb(database);
        
        const dataRef = database.ref('viewTracker');
        dataRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            setTimeLabels(data.timeLabels || timeLabels);
            setGoals(data.goals || goals);
            setViewData(data.viewData || viewData);
            setLastUpdate(data.lastUpdate || '');
          }
        });
      }
    };

    return () => {
      document.body.removeChild(script1);
      document.body.removeChild(script2);
    };
  }, []);

  const handleLogin = () => {
    if (password === 'admin2024') {
      setIsAdmin(true);
      setShowLogin(false);
      setLoginError('');
      setPassword('');
    } else {
      setLoginError('비밀번호가 올바르지 않습니다.');
    }
  };

  const handleLogout = () => {
    setIsAdmin(false);
    setPassword('');
  };

  const saveToFirebase = () => {
    if (db && isAdmin) {
      const now = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
      db.ref('viewTracker').set({
        timeLabels,
        goals,
        viewData,
        lastUpdate: now
      });
    }
  };

  const updateGoal = (index, value) => {
    const newGoals = [...goals];
    newGoals[index] = parseInt(value) || 0;
    setGoals(newGoals);
  };

  const updateView = (songIndex, timeIndex, value) => {
    const newData = [...viewData];
    newData[songIndex] = [...newData[songIndex]];
    newData[songIndex][timeIndex] = parseInt(value) || 0;
    setViewData(newData);
  };

  const updateTimeLabel = (index, value) => {
    const newLabels = [...timeLabels];
    newLabels[index] = value;
    setTimeLabels(newLabels);
  };

  const getCurrentViews = (songIndex) => {
    return viewData[songIndex][viewData[songIndex].length - 1] || 0;
  };

  const getAchievementRate = (songIndex) => {
    const current = getCurrentViews(songIndex);
    const goal = goals[songIndex];
    return goal > 0 ? Math.min((current / goal) * 100, 100) : 0;
  };

  const formatNumber = (num) => {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  };

  const copyShareLink = () => {
    const url = window.location.href.split('?')[0];
    navigator.clipboard.writeText(url);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  if (showLogin) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
          <div className="flex items-center justify-center mb-6">
            <div className="bg-purple-100 p-4 rounded-full">
              <Lock className="text-purple-600" size={32} />
            </div>
          </div>
          <h2 className="text-2xl font-bold text-center mb-6 text-gray-800">관리자 로그인</h2>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">비밀번호</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                placeholder="관리자 비밀번호 입력"
              />
            </div>
            {loginError && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-3 text-red-700 text-sm">
                {loginError}
              </div>
            )}
            <div className="flex gap-3">
              <button
                onClick={() => setShowLogin(false)}
                className="flex-1 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
              >
                취소
              </button>
              <button
                onClick={handleLogin}
                className="flex-1 bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 transition"
              >
                로그인
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 p-4">
      <div className="max-w-7xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-2">
                <TrendingUp className="text-purple-600" />
                유튜브 조회수 트래커
              </h1>
              {lastUpdate && (
                <p className="text-sm text-gray-500 mt-1">마지막 업데이트: {lastUpdate}</p>
              )}
            </div>
            <div className="flex gap-2">
              <button
                onClick={copyShareLink}
                className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
              >
                {copied ? <Check size={18} /> : <Copy size={18} />}
                {copied ? '복사됨!' : '링크 복사'}
              </button>
              {isAdmin ? (
                <>
                  <button
                    onClick={saveToFirebase}
                    className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
                  >
                    <Share2 size={18} />
                    저장하기
                  </button>
                  <button
                    onClick={handleLogout}
                    className="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition"
                  >
                    <LogOut size={18} />
                    로그아웃
                  </button>
                </>
              ) : (
                <button
                  onClick={() => setShowLogin(true)}
                  className="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition"
                >
                  <Lock size={18} />
                  관리자
                </button>
              )}
            </div>
          </div>

          <div className="space-y-6">
            {songs.map((song, songIndex) => (
              <div key={song.id} className="border border-gray-200 rounded-xl p-5 bg-gray-50">
                <div className="flex items-start justify-between mb-4">
                  <div className="flex-1">
                    <h3 className="font-semibold text-lg text-gray-800 mb-2">{song.title}</h3>
                    <div className="flex items-center gap-4 flex-wrap">
                      <div className="flex items-center gap-2">
                        <span className="text-sm text-gray-600">목표:</span>
                        {isAdmin ? (
                          <input
                            type="number"
                            value={goals[songIndex]}
                            onChange={(e) => updateGoal(songIndex, e.target.value)}
                            className="w-32 px-2 py-1 border border-gray-300 rounded text-sm"
                          />
                        ) : (
                          <span className="font-semibold text-purple-600">
                            {formatNumber(goals[songIndex])}
                          </span>
                        )}
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-sm text-gray-600">현재:</span>
                        <span className="font-semibold text-blue-600">
                          {formatNumber(getCurrentViews(songIndex))}
                        </span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-sm text-gray-600">달성률:</span>
                        <span className="font-bold text-green-600">
                          {getAchievementRate(songIndex).toFixed(1)}%
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="mb-4">
                  <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                    <div
                      className="bg-gradient-to-r from-purple-500 to-pink-500 h-full rounded-full transition-all duration-500"
                      style={{ width: `${getAchievementRate(songIndex)}%` }}
                    />
                  </div>
                </div>

                {isAdmin ? (
                  <div className="bg-white rounded-lg p-4 border border-gray-200 overflow-x-auto">
                    <table className="w-full min-w-[600px]">
                      <thead>
                        <tr className="border-b border-gray-200">
                          <th className="text-left py-2 px-2 text-sm font-semibold text-gray-700">시간</th>
                          {timeLabels.map((label, timeIndex) => (
                            <th key={timeIndex} className="py-2 px-2">
                              <input
                                type="text"
                                value={label}
                                onChange={(e) => updateTimeLabel(timeIndex, e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-sm text-center"
                                placeholder={`시간${timeIndex + 1}`}
                              />
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td className="py-2 px-2 text-sm text-gray-600">조회수</td>
                          {viewData[songIndex].map((view, timeIndex) => (
                            <td key={timeIndex} className="py-2 px-2">
                              <input
                                type="number"
                                value={view}
                                onChange={(e) => updateView(songIndex, timeIndex, e.target.value)}
                                className="w-full px-2 py-1 border border-gray-300 rounded text-sm text-center"
                                placeholder="0"
                              />
                            </td>
                          ))}
                        </tr>
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <div className="bg-white rounded-lg p-4 border border-gray-200">
                    <div className="grid grid-cols-5 gap-2">
                      {timeLabels.map((label, timeIndex) => (
                        <div key={timeIndex} className="text-center">
                          <div className="text-xs text-gray-600 mb-1">{label}</div>
                          <div className="text-sm font-semibold text-gray-800">
                            {formatNumber(viewData[songIndex][timeIndex])}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>

        <div className="text-center text-sm text-gray-500">
          총 {songs.length}곡 | 전체 평균 달성률:{' '}
          <span className="font-semibold text-purple-600">
            {(songs.reduce((sum, _, idx) => sum + getAchievementRate(idx), 0) / songs.length).toFixed(1)}%
          </span>
        </div>
      </div>
    </div>
  );
}